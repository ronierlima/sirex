<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/layout/template.xhtml">


	<ui:define name="title">Listar Atendimentos</ui:define>

	<ui:define name="breadcrumb">
		<f:metadata>
			<f:viewParam name="homeOutcome" value="/paginas/principal.xhtml" />
			<f:viewParam name="value" value="Atendimento,Lista de Espera" />
			<f:viewParam name="outcome"
				value="/paginas/atendimento/listarAtendimentos.xhtml" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<h:form id="form">

			<div class="grid">
				<div class="col-12 md:col-12">
					<div class="card ui-fluid">
						<h5>Pesquisar Atendimentos</h5>
						<div class="formgrid grid">

							<div class="field col-12 md:col-4">
								<p:outputLabel value="Nome" />
								<p:inputText value="#{pesquisarAtendimentosBean.filtro.nome}"
									placeholder="Nome do Paciente" />
							</div>
							
							<div class="field col-12 md:col-2">
								<p:outputLabel value="Prontuário" />
								<p:inputText placeholder="Prontuário"
									value="#{pesquisarAtendimentosBean.filtro.prontuario}" />
							</div>							

							<div class="field col-12 md:col-4">
								<p:outputLabel value="Responsável" />
								<p:inputText placeholder="Nome do Responsável"
									value="#{pesquisarAtendimentosBean.filtro.nomeResponsavel}" />
							</div>
							
							<div class="field col-12 md:col-2">
								<p:outputLabel value="Status" />
								<p:selectCheckboxMenu dynamic="true" label="Selecione um Status" 
														selectedLabel="#{pesquisarAtendimentosBean.filtro.statusSelecionadosToString}"
														converter="omnifaces.SelectItemsConverter"
														emptyLabel="Selecione um Status" updateLabel="true"
														style="min-width: 15rem" panelStyle="width: 30rem"
														scrollHeight="250" id="status" value="#{pesquisarAtendimentosBean.filtro.statusSelecionados}">
														
														<p:ajax event="toggleSelect" global="false" update="form:tabelaDados,form:status"/>
                										<p:ajax event="itemSelect" global="false" update="form:tabelaDados,form:status"/>
                										<p:ajax event="itemUnselect" global="false" update="form:tabelaDados,form:status"/>
														
									<f:selectItems value="#{pesquisarAtendimentosBean.status}"
										var="status" itemLabel="#{status.descricao}"
										itemValue="#{status}" />
								</p:selectCheckboxMenu>
							</div>							

							<div class="field col-12 md:col-4">
								<p:outputLabel value="Tipo de Responsável" />

								<p:selectOneMenu
									value="#{pesquisarAtendimentosBean.filtro.tipoResponsavel}">

									<f:selectItem itemLabel="Todos" itemValue="#{null}"
										noSelectionOption="true" />

									<f:selectItems value="#{pesquisarAtendimentosBean.tipos}"
										var="tipo" itemLabel="#{tipo.nome}" itemValue="#{tipo}" />

								</p:selectOneMenu>

							</div>

							<div class="field col-12 md:col-4">
								<p:outputLabel value="Data de Início" />								
								<p:datePicker id="dataInicial" validatorMessage="Data Inicial Inválida" selectionMode="single" 
								maxdate="#{pesquisarAtendimentosBean.dataAtual}" monthNavigator="true" yearNavigator="true" 
								pattern="dd/MM/yyyy" mask="99/99/9999" value="#{pesquisarAtendimentosBean.filtro.dataInicio}" 
								hideOnRangeSelection="true" yearRange="#{pesquisarAtendimentosBean.yearRange}"/>
							</div>

							<div class="field col-12 md:col-4">
								<p:outputLabel value="Data de Fim" />
								<p:datePicker validatorMessage="Data Final Inválida" id="dataFinal" selectionMode="single" 
								maxdate="#{pesquisarAtendimentosBean.dataAtual}" monthNavigator="true" yearNavigator="true" 
								pattern="dd/MM/yyyy" mask="99/99/9999" value="#{pesquisarAtendimentosBean.filtro.dataFim}" 
								hideOnRangeSelection="true" yearRange="#{pesquisarAtendimentosBean.yearRange}"/>
							</div>
						</div>
						
						<div class="ui-lg-1 ui-sm-12">

								<p:commandButton value="Pesquisar"
								action="#{pesquisarAtendimentosBean.pesquisar}" update="@form"
								icon="pi pi-search" />

							</div>

					</div>
				</div>
			</div>

			<div class="grid table-demo">
				<div class="col-12">
					<div class="card">

						<p:dataTable widgetVar="customersDT2" var="atendimento"
							id="tabelaDados" lazy="true"
							value="#{pesquisarAtendimentosBean.model}" selectionMode="single"
							reflow="true" rows="10" paginator="true"
							paginatorAlwaysVisible="tr" 
							paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown} {Exporters}"
							currentPageReportTemplate="Exibindo de {startRecord} a {endRecord} no total de {totalRecords} registros - Página: {currentPage}/{totalPages}"
							selection="#{pesquisarAtendimentosBean.atendimentoSelecionado}"
							rowKey="#{atendimento.id}" scrollable="true" scrollHeight="500"
							styleClass="ui-datatable-striped ui-datatable-sm">

							<f:facet name="header">
								<div class="customers-table-header">
									<span style="font-weight: bold">Atendimentos Encontrados</span>

									<p:commandButton value="Exportar Excel" styleClass="ui-button-success mr-2 mb-2" icon="fa fa-file-excel-o"
									 disabled="#{pesquisarAtendimentosBean.model.rowCount eq 0}" id="btnxls">
                    					<p:dataExporter type="xls" target="tabelaDados" fileName="atendimentos_encontrados"
                    					postProcessor="#{utilExportacaoBean.postProcessXLS}" encoding="utf-8" bufferSize="1"/>
                					</p:commandButton>

								</div>
							</f:facet>

							<p:column headerText="Código" sortBy="#{atendimento.paciente.id}"
								style="text-align:center" width="120"
								filterBy="#{atendimento.paciente.id}">
								<h:outputText value="#{atendimento.paciente.id}" />
							</p:column>

							<p:column headerText="Prontuário" width="120" style="text-align:center"
								sortBy="#{atendimento.paciente.prontuario}"
								filterBy="#{atendimento.paciente.prontuario}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.paciente.prontuario}" />
							</p:column>

							<p:column headerText="Nome" style="text-align:center"
								sortBy="#{atendimento.paciente.nomeCompleto}"
								filterBy="#{atendimento.paciente.nomeCompleto}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.paciente.nomeCompleto}" />
							</p:column>

							<p:column headerText="Responsável" style="text-align:center">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.responsavelRetirada.nome}" />
							</p:column>

							<p:column headerText="Data de Nascimento" width="140" style="text-align:center"
								filterBy="#{atendimento.paciente.dataNascimento}">
								<h:outputText value="#{atendimento.paciente.dataNascimento}">
									<f:convertDateTime pattern="dd/MM/yyyy" />
								</h:outputText>
							</p:column>

							<p:column headerText="Hora Atendimento" width="160" style="text-align:center"
								sortBy="#{atendimento.paciente.dataInclusao}"
								filterBy="#{atendimento.dataInclusao}">
								<h:outputText value="#{atendimento.dataInclusao}">
									<f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
								</h:outputText>
							</p:column>

							<p:column headerText="Status" sortBy="#{atendimento.status}"
								exportable="false" width="200" filterBy="#{atendimento.status}"
								style="text-align:center">

								<span class="customer-badge #{atendimento.status.estiloCss}">#{atendimento.status.descricao}</span>
								<ui:fragment rendered="#{atendimento.emergencial}">
									<br />
									<br />
									<span class="customer-badge status-unqualified">Emergencial</span>
								</ui:fragment>
							</p:column>

							<p:column headerText="Status" style="display:none">
								<h:outputText value="#{atendimento.status.descricao}" />
							</p:column>

							<p:column headerText="Opções" width="120" exportable="false"
								style="text-align:center">

								<p:menuButton value="Ações" menuStyleClass="superWide">

									<p:menuitem value="Visualizar Entrega" icon="pi pi-eye"
										action="#{pesquisarAtendimentosBean.visualizar}"
										disabled="#{atendimento.entregaNaoRealizada}"
										rendered="#{seguranca.podeVisualizarAtendimento}">

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{pesquisarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>
									
									<p:menuitem value="Imprimir Recibo" icon="pi pi-file-pdf"
										actionListener="#{pesquisarAtendimentosBean.gerarComprovanteEntrega(atendimento)}"
										disabled="#{atendimento.entregaNaoRealizada}"
										rendered="#{seguranca.podeVisualizarAtendimento}">	
										<p:fileDownload value="#{utilRelatorioMBean.documento}" />
									</p:menuitem>
									
									<p:menuitem value="Materiais Entregues" icon="pi pi-file-pdf" 									    
									    rendered="#{seguranca.podeVisualizarAlgumEstoque}"
										action="#{pesquisarAtendimentosBean.relatorioMateriaisEntregues}"
										process="@this">
										<f:setPropertyActionListener value="#{atendimento}"
											target="#{pesquisarAtendimentosBean.atendimentoSelecionado}"/>
									</p:menuitem>																	

								</p:menuButton>

							</p:column>

						</p:dataTable>

					</div>
				</div>
			</div>

		</h:form>

		<style>
.superWide {
	width: 200px;
	min-width: 200px;
	max-width: 200px;
}
</style>
	</ui:define>

</ui:composition>