<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/layout/template.xhtml">


	<ui:define name="title">Listar Atendimentos</ui:define>

	<ui:define name="breadcrumb">
		<f:metadata>
			<f:viewParam name="homeOutcome" value="/paginas/principal.xhtml" />
			<f:viewParam name="value" value="Atendimento,Lista de Espera" />
			<f:viewParam name="outcome"
				value="/paginas/atendimento/listarAtendimentos.xhtml" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<h:form id="form">

			<div class="grid table-demo">
				<div class="col-12">
					<div class="card">

						<p:idleMonitor timeout="40000">
							<p:ajax event="idle" update="dtatendimento" listener="#{listarAtendimentosBean.acaoInatividade}"/>
						</p:idleMonitor>

						<p:dataTable id="dtatendimento" resizableColumns="true" widgetVar="customersDT2" var="atendimento"
							lazy="true" value="#{listarAtendimentosBean.model}"
							selectionMode="single" reflow="true" rows="10" paginator="true"
							paginatorAlwaysVisible="false" paginatorPosition="bottom"
							selection="#{listarAtendimentosBean.atendimentoSelecionado}"
							rowKey="#{atendimento.id}" scrollable="true" scrollHeight="500"
							styleClass="ui-datatable-striped ui-datatable-sm">

							<f:facet name="header">
								<div class="customers-table-header">


									<p:commandButton value="Adicionar Atendimento"
										icon="pi pi-plus"
										rendered="#{seguranca.podeIncluirAtendimento}"
										actionListener="#{pesquisarPacientesMBean.abrirDialogo}"
										styleClass="ui-button-success" style="margin-right: .5rem">

										<p:ajax event="dialogReturn" update="@form"
											listener="#{listarAtendimentosBean.aoFecharDialogo}" />

									</p:commandButton>

									<div class="col-6">


										<div class="ui-fluid formgrid grid">
											<div class="field col-12 md:col-4">
												<p:outputLabel value="Nome | Prontuário | Código" />
												<p:inputText value="#{listarAtendimentosBean.filtro.nome}" style="text-transform:uppercase"
												onkeypress="if(event.keyCode==13){document.getElementById('form:dtatendimento:btnBusca').click();return false;}"/>
											</div>

											<div class="field col-12 md:col-8">
												<p:outputLabel value="Status" />
												<div class="ui-inputgroup">

													<p:selectCheckboxMenu dynamic="true" label="Selecione um Status"
														selectedLabel="#{listarAtendimentosBean.filtro.statusSelecionadosToString}"
														converter="omnifaces.SelectItemsConverter"
														emptyLabel="Selecione um Status" updateLabel="true"
														style="min-width: 15rem" panelStyle="width: 30rem"
														scrollHeight="250" id="status" value="#{listarAtendimentosBean.filtro.statusSelecionados}">
														
														<p:ajax event="toggleSelect" global="false" update="form:dtatendimento"/>
                										<p:ajax event="itemSelect" global="false" update="form:dtatendimento"/>
                										<p:ajax event="itemUnselect" global="false" update="form:dtatendimento"/>
														
														<f:selectItems value="#{listarAtendimentosBean.status}"
															var="status" itemLabel="#{status.descricao}"
															itemValue="#{status}" />
													</p:selectCheckboxMenu>

													<p:commandButton value="Pesquisar" id="btnBusca" icon="pi pi-search"
														action="#{listarAtendimentosBean.pesquisar}"
														update="@form" styleClass="ui-button-help" />														

												</div>												
											</div>

										</div>
									</div>

								</div>
							</f:facet>
							
							<p:column style="width:2rem">
                				<p:rowToggler/>
            				</p:column>

							<p:column headerText="Prontuário" width="80" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.paciente.prontuario}"
								filterBy="#{atendimento.paciente.prontuario}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.paciente.prontuario}" />
							</p:column>

							<p:column headerText="Paciente" width="160" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.paciente.nomeCompleto}"
								filterBy="#{atendimento.paciente.nomeCompleto}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.paciente.nomeCompleto}" />
									
							    <p:outputPanel rendered="#{atendimento.paciente.pacienteJudicializado}">
									<span class="customer-badge status-reverted">JUDICIALIZADO</span>
									<i class="fa-solid fa-gavel" id="jud" />
								</p:outputPanel>
								
							</p:column>

							<p:column headerText="Data de Nascimento" width="70" style="text-align:center;white-space:normal!important"
								filterBy="#{atendimento.paciente.dataNascimento}">
								<h:outputText value="#{atendimento.paciente.dataNascimento}">
									<f:convertDateTime pattern="dd/MM/yyyy" />
								</h:outputText>
							</p:column>

							<p:column headerText="Data-Hora Atendimento" width="80" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.dataInclusao}"
								filterBy="#{atendimento.dataInclusao}">
								<h:outputText value="#{atendimento.dataInclusao}">
									<f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" />
								</h:outputText>
							</p:column>
							
							<p:column headerText="Responsável pela Inclusão" width="100" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.usuarioInclusao.nome}"
								filterBy="#{atendimento.usuarioInclusao.nome}">
								<h:outputText style="vertical-align: middle;"
									value="#{atendimento.usuarioInclusao.nome}" />
							</p:column>
							
							<p:column headerText="Responsável pela Reavaliação" width="100" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.usuarioFinalizouReavaliacao}"
								filterBy="#{atendimento.usuarioFinalizouReavaliacao}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.usuarioFinalizouReavaliacao}" rendered="#{atendimento.atendimentoReavaliacao}"/>
							</p:column>
							
							<p:column headerText="Responsável pela Liberação" width="100" style="text-align:center;white-space:normal!important"
								sortBy="#{atendimento.solicitacaoEstoque.usuarioInclusao.nome}"
								filterBy="#{atendimento.solicitacaoEstoque.usuarioInclusao.nome}">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{atendimento.solicitacaoEstoque.usuarioInclusao.nome}" />
							</p:column>

							<p:column headerText="Tipo" width="100" style="text-align:center;white-space:normal!important">
								<span class="customer-badge #{atendimento.tipo.estiloCss}">#{atendimento.tipo.descricao}</span>
							</p:column>

							<p:column headerText="Status" sortBy="#{atendimento.status}"
								width="100" filterBy="#{atendimento.status}"
								style="text-align:center;white-space:normal!important">

								<span class="customer-badge #{atendimento.status.estiloCss}">#{atendimento.status.descricao}</span>
								<ui:fragment rendered="#{atendimento.emergencial}">
									<br />
									<br />
									<span class="customer-badge status-unqualified">Emergencial</span>
								</ui:fragment>
							</p:column>

							<p:column headerText="Opções" width="80" style="text-align:center;white-space:normal!important">

								<p:menuButton value="Evoluir" menuStyleClass="superWide">

									<p:menuitem value="Avaliação/Reavaliação"
										icon="pi pi-step-forward" disabled="#{atendimento.desabilitaBtnReavaliacao}"
										action="#{listarAtendimentosBean.iniciarReavaliacao}"
										rendered="#{seguranca.podeIniciarAtendimento}">

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{listarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>

									<p:menuitem value="Atendimento Emergencial"
										icon="pi pi-step-forward" disabled="#{atendimento.desabilitaBtnAtendimentoEmergencial}"
										action="#{listarAtendimentosBean.iniciarAtendimentoEmergencial}"
										rendered="#{seguranca.podeIniciarEmergencial}"
										style="font-weight:bold; background:#f97878; color:#FFFFFF;">

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{listarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>

									<p:divider />

									<p:menuitem value="Liberar Produtos" icon="fa fa-handshake"
										action="#{listarAtendimentosBean.iniciarEntrega}"
										disabled="#{atendimento.desabilitaBtnLiberacao}"
										rendered="#{seguranca.podeLiberarProdutos}">

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{listarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>

									<p:menuitem value="Visualizar Entrega" icon="pi pi-eye"
										action="#{listarAtendimentosBean.visualizar}"
										disabled="#{atendimento.desabilitaBtnVisualizarEntrega}"
										rendered="#{seguranca.podeVisualizarAtendimento}">

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{listarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>

									<p:menuitem value="Excluir Atendimento" icon="pi pi-trash"
										disabled="#{atendimento.desabilitaBtnExcluir}"
										action="#{listarAtendimentosBean.excluir}" update="@form"
										rendered="#{seguranca.podeExcluirAtendimento}">

										<p:confirm header="Confirmação"
											message="Deseja realmente excluir o atendimento?"
											icon="pi pi-exclamation-triangle" />

										<f:setPropertyActionListener value="#{atendimento}"
											target="#{listarAtendimentosBean.atendimentoSelecionado}" />

									</p:menuitem>

								</p:menuButton>

							</p:column>

							<p:rowExpansion>

								<p:dataTable scrollable="true" resizableColumns="true" widgetVar="itensEntregues" 
									styleClass="ui-datatable-striped ui-datatable-sm" var="item"
									id="tabelaDados" value="#{atendimento.itensUltimaEntrega}" 
									reflow="true" rowKey="#{item.id}" style="text-align:center!important">

									<f:facet name="header">
										<div align="center">
											<span style="font-weight: bold">Últimos Itens Entregues</span>
										</div>
									</f:facet>

									<p:column width="120" headerText="Data/Hora" style="text-align:center;white-space:normal!important">
										<h:outputText value="#{item.dataInclusao}">
											<f:convertDateTime pattern="dd/MM/yyyy - HH:mm" />
										</h:outputText>
									</p:column>

									<p:column width="500" headerText="Produto" style="text-align:center;white-space:normal!important">
										<h:outputText style="vertical-align: middle;"
											value="#{item.produto.descricao}" />
									</p:column>

									<p:column width="120" headerText="Marca" style="text-align:center;white-space:normal!important">
										<h:outputText style="vertical-align: middle;"
											value="Marca: #{item.produto.marca.descricao}" />
									</p:column>

									<p:column width="100" headerText="Quantidade Entregue" 
										style="text-align:center;white-space:normal!important">
										<h:outputText style="vertical-align: middle;"
											value="Qtd Entregue: #{item.quantidadeEstoque}" />	
									</p:column>

								</p:dataTable>
								
							</p:rowExpansion>

						</p:dataTable>

					</div>
				</div>
			</div>


		</h:form>

		<style>
.superWide {
	width: 250px;
	min-width: 250px;
	max-width: 250px;
}
</style>
	</ui:define>

</ui:composition>