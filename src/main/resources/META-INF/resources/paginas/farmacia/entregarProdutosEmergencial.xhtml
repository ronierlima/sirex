<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	template="/WEB-INF/layout/template.xhtml">

	<ui:define name="title">Liberação de Produtos - Emergencial</ui:define>

	<ui:define name="breadcrumb">
		<f:metadata>
			<f:viewParam name="homeOutcome" value="/paginas/principal" />
			<f:viewParam name="value" value="Farmácia,Atendimento Emergencial" />
			<f:viewParam name="outcome"
				value="/paginas/atendimento/listarAtendimentos.xhtml" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<h:form id="download">
			<p:commandButton id="btnDownloadNota" value="Download Nota"
				ajax="false" process="@this" style="display:none"
				onclick="PrimeFaces.monitorDownload(start, stop);"
				icon="pi fa-download" styleClass="mr-2">
				<p:fileDownload value="#{entregaEmergencialBean.documento}" />
			</p:commandButton>
		</h:form>

		<h:form id="frm">
			<div class="grid">

				<div class="col-12">

					<div class="card">
						<p:fieldset legend="Informações do Paciente" toggleable="true"
							toggleSpeed="500">


							<div class="grid">
								<div class="col-12">
									<div class="ui-fluid">
										<div class="formgrid grid">

											<div class="field col">
												<p:outputLabel value="Nome" />

												<div class="ui-inputgroup">
													<p:inputText readonly="true"
														value="#{entregaEmergencialBean.atendimentoSelecionado.paciente.nomeCompleto}" />

													<p:commandButton value="Histórico" process="@this"
														pt:data-tooltip="Clique p/ Visualizar o Histórico de Retiradas."
														actionListener="#{entregaEmergencialBean.abrirDlgHistorico}"
														icon="fa fa-history" />

												</div>
											</div>

											<div class="field col">
												<p:outputLabel value="CPF" />
												<p:inputText readonly="true"
													value="#{entregaEmergencialBean.atendimentoSelecionado.paciente.cpf}" />
											</div>

											<div class="field col">
												<p:outputLabel value="Nº do Prontuário" />
												<p:inputText readonly="true"
													value="#{entregaEmergencialBean.atendimentoSelecionado.paciente.prontuario}" />
											</div>

											<div class="field col">
												<p:outputLabel value="Data da Próxima Entrega" />

												<p:inputText readonly="true" id="dtUltimaEntrega"
													value="#{entregaEmergencialBean.atendimentoSelecionado.paciente.dataProximaRetirada}">
													<f:convertDateTime type="localDate" pattern="dd/MM/yyyy" />
												</p:inputText>

											</div>

											<div class="field col-12 md:col-12">
												<p:outputLabel value="Observação" for="@next" />
												<p:inputTextarea placeholder="Motivo do Atendimento"
													readonly="true"
													value="#{entregaEmergencialBean.atendimentoSelecionado.observacao}" />
											</div>


										</div>


									</div>

								</div>

							</div>


						</p:fieldset>


						<p:fieldset legend="Informações da Retirada" toggleable="true"
							toggleSpeed="500">

							<p:outputPanel id="pnlResp" styleClass="ui-fluid formgrid grid"
								rendered="#{entregaEmergencialBean.atendimentoSelecionado.liberacao}">

								<div class="field col-12 md:col-2">
									<p:outputLabel for="tp" value="Tipo de Responsável" />


									<p:selectOneMenu id="tp" autoWidth="false"
										value="#{entregaEmergencialBean.tipoSelecionado}"
										converter="omnifaces.SelectItemsConverter">

										<p:ajax update="frm:pnlResp" process="@this"
											listener="#{entregaEmergencialBean.listarResponsaveis}" />

										<f:selectItem itemLabel="Selecione" itemValue="#{null}"
											noSelectionOption="true" />

										<f:selectItems
											value="#{entregaEmergencialBean.tiposResponsaveis}" var="tp"
											itemLabel="#{tp.nome}" itemValue="#{tp}" />

									</p:selectOneMenu>


								</div>

								<div class="field col-12 md:col-4">

									<p:outputLabel for="resp" value="Quem Está Retirando" />

									<div class="ui-inputgroup">

										<p:selectOneMenu id="resp" required="true" autoWidth="false"
											requiredMessage="Informe o Responsavél pela Retirada."
											value="#{entregaEmergencialBean.responsavelSelecionado}"
											converter="omnifaces.SelectItemsConverter">

											<p:ajax update="frm:pnlResp" process="@this" />

											<f:selectItem itemLabel="Selecione" itemValue="#{null}"
												noSelectionOption="true" />

											<f:selectItems value="#{entregaEmergencialBean.responsaveis}"
												var="tp" itemLabel="#{tp.nome}" itemValue="#{tp}" />

										</p:selectOneMenu>

										<p:commandButton value="Cadastrar" process="@this"
											disabled="#{entregaEmergencialBean.isDesabilitaBtnCadastro()}"
											rendered="#{seguranca.podeIncluirPaciente}"
											actionListener="#{entregaEmergencialBean.abrirDlgResponsavel}"
											pt:data-tooltip="Adiciona um Novo Responsavél Pela Retirada."
											icon="pi pi-user-plus">

											<p:ajax event="dialogReturn" update="@form"
												listener="#{entregaEmergencialBean.aoFecharDialogo}" />

										</p:commandButton>

									</div>
								</div>

								<div class="field col-12 md:col-4">
									<p:outputLabel value="Nome" />
									<p:inputText readonly="true"
										pt:data-tooltip="Adicionar Paciente a Lista de Espera."
										value="#{entregaEmergencialBean.responsavelSelecionado.nome}" />
								</div>

								<div class="field col-12 md:col-2">
									<p:outputLabel value="CPF/CNPJ" />
									<p:inputText readonly="true"
										value="#{entregaEmergencialBean.responsavelSelecionado.cpf}" />
								</div>



								<div class="field col-12 md:col-6">
									<p:fileUpload label="Anexar Documento" uploadLabel="Enviar"
										cancelLabel="Cancelar" update="frm:pnlResp"
										rendered="#{entregaEmergencialBean.tipoSelecionado.obrigaComprovante}"
										required="#{entregaEmergencialBean.tipoSelecionado.obrigaComprovante}"
										listener="#{entregaEmergencialBean.handleFileUpload}"
										mode="advanced" dragDropSupport="false" multiple="false"
										sizeLimit="1000000" allowTypes="/(\.|\/)(pdf)$/"
										style="width:100%" />
								</div>
								<div class="col-12 md:col-6">

									<ui:repeat var="doc"
										value="#{entregaEmergencialBean.atendimentoSelecionado.documentos}">

										<p:commandButton value="Baixar #{doc.doc}"
											icon="fa fa-download" style="margin-top:2px;"
											oncomplete="document.getElementById('download:btnDownloadNota').click()"
											action="#{entregaEmergencialBean.prepararDownload}"
											styleClass="green-btn" process="@this" update="@this">

											<f:setPropertyActionListener value="#{doc}"
												target="#{entregaEmergencialBean.docSelecionado}" />

										</p:commandButton>

									</ui:repeat>

								</div>
							</p:outputPanel>
						</p:fieldset>

						<p:fieldset legend="Itens" id="fielSet">

							<div class="formgroup-inline">

								<div class="field">

									<p:commandButton value="Estoque da Farmácia" process="@this"
										style="margin-left:2px" styleClass="ui-button-success"
										actionListener="#{entregaEmergencialBean.abrirDlgEstoque}"
										pt:data-tooltip="Clique p/ Visualizar o Estoque da Farmácia."
										icon="fa fa-fw fa-house-medical" />

								</div>

							</div>
							
							<ui:repeat var="item"
								value="#{entregaEmergencialBean.atendimentoSelecionado.solicitacaoEstoque.itensDaSolicitacao}">

								<div class="ui-fluid formgrid grid">
									<p:outputPanel styleClass="field col-12 md:col-2"
										rendered="#{item.bolsa}">

										<p:outputLabel value="Marca" />
										<p:inputText value="#{item.produto.marca.descricao}"
											readonly="true" />

									</p:outputPanel>

									<div class="field col-12 #{item.bolsa ? 'md:col-4' : 'md:col-6'}">
										<p:outputLabel value="Produto" for="@next" />
										<p:inputText value="#{item.produto.descricao}"
											pt:data-tooltip="#{item.produto.descricao}" readonly="true" />
									</div>

									<div class="field col-12 md:col-2">

										<p:outputLabel value="Quantidade Solicitada" for="@next" />
										<p:inputText value="#{item.quantidadeSolicitada}"
											readonly="true" />

									</div>

									<p:outputPanel styleClass="field col-12 md:col-2">

										<p:outputLabel value="Quantidade Entregue" for="@next" />
										<p:inputNumber maxValue="#{item.quantidadeSolicitada}"
											minValue="0" decimalPlaces="0" modifyValueOnWheel="false"
											value="#{item.quantidadeEstoque}" required="true"
											requiredMessage="Informe a Quantidade Entregue">
											<p:ajax event="change" process="@this"
												update="pnlJustificativa @this" />
										</p:inputNumber>

									</p:outputPanel>

									<p:outputPanel id="pnlJustificativa"
										styleClass="field col-12 md:col-2">

										<p:outputLabel value="Justificativa" for="@next" />
										<p:inputText value="#{item.justificativaStatus}"
											requiredMessage="Informe a Justificativa da Entrega"
											required="#{item.exigeJustificativa}" />

									</p:outputPanel>

								</div>
							</ui:repeat>

						</p:fieldset>



						<div align="left">

							<p:commandButton value="Finalizar Liberação" icon="pi pi-check" update="@form"
								id="btnFinalizar" action="#{entregaEmergencialBean.finalizarEntrega}"								
								disabled="#{entregaEmergencialBean.isDesabilitarBtnFinalizar()}"
								styleClass="ui-button-success" style="margin-top: 10px;" />

							<p:button outcome="/paginas/farmacia/liberarProdutos.xhtml"
								value="Cancelar" icon="pi pi-delete-left"
								style="margin-top: 10px;margin-left:2px"
								styleClass="ui-button-danger"/>


						</div>
					</div>
				</div>
			</div>

		</h:form>
		<h:form id="frmFinalizacao">
			<div class="grid crud-demo">
				<p:dialog header="Comprovante" showEffect="fade" width="35%"
					modal="true" closable="false" closeOnEscape="false" widgetVar="finalizarAtendimentoDlg" responsive="true">

					<p:outputPanel id="manage-product-content" class="ui-fluid">

						<div class="field">
							<p:commandButton id="btnDownloadNota" value="Gerar Comprovante"
								process="@this"
								actionListener="#{utilRelatorioMBean.gerarComprovante(entregaEmergencialBean.atendimentoSelecionado)}"
								icon="pi pi-download" styleClass="mr-2">
								<p:fileDownload value="#{utilRelatorioMBean.documento}" />
							</p:commandButton>
						</div>

						<p:outputPanel styleClass="field" rendered="#{seguranca.obrigaAnexo}">
							<p:fileUpload label="Anexar Comprovante Assinado"
								uploadLabel="Enviar" cancelLabel="Cancelar"
								update="manage-product-content"
								accept="application/pdf, image/jpeg, image/png"
								invalidFileMessage="Tipo de Arquivo Inválido. Selecione um PDF ou Imagem JPEG/PNG."
								invalidSizeMessage="Tamanho do Arquivo Excede o Limite Permitido"
								listener="#{entregaEmergencialBean.anexarComprovante}"
								mode="advanced" dragDropSupport="false" multiple="false"
								sizeLimit="1000000" allowTypes="/(\.|\/)(pdf|png|jpeg)$/"
								style="width:100%" />
						</p:outputPanel>

						<p:outputPanel styleClass="field" rendered="#{seguranca.obrigaAnexo}">
							<p:outputLabel value="Observação" for="@next" />
							<p:inputTextarea
								value="#{entregaEmergencialBean.atendimentoSelecionado.observacao}"
								required="#{seguranca.obrigaAnexo and entregarProdutosBean.atendimentoSelecionado.comprovanteEntregaAnexado}"
								placeholder="#{seguranca.obrigaAnexo ? 'Obrigatória na ausencia do anexo assinado.' : 'Opcional'}"/>
						</p:outputPanel>

					</p:outputPanel>

					<f:facet name="footer">
						<p:commandButton value="Finalizar" icon="pi pi-check" process="@form"
							action="#{entregaEmergencialBean.gravarDadosDeAnexo}" />
						<p:commandButton value="Cancelar" icon="pi pi-times" rendered="#{!seguranca.obrigaAnexo}"
							onclick="PF('finalizarAtendimentoDlg').hide()" class="ui-button-danger"/> 						
					</f:facet>
				</p:dialog>

			</div>
		</h:form>

	</ui:define>
</ui:composition>