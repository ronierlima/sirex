<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/layout/template.xhtml">

	<ui:define name="title">Transferência de Pacientes</ui:define>

	<ui:define name="">
		<f:metadata>
			<f:viewParam name="paginaAnterior"
				value="/paginas/paciente/listarPacientes.xhtml" />
			<f:viewParam name="homeOutcome" value="/paginas/principal" />
			<f:viewParam name="value" value="Pacientes,Transferência de Paciente" />
			<f:viewParam name="outcome"
				value="/paginas/paciente/transferenciaPaciente" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">

		<h:form prependId="false">
			<div class="grid">
				<div class="col-12 md:col-12">
					<div class="card ui-fluid">

						<p:panel rendered="#{transferenciaPacienteBean.transferencia.paciente.id!=null}">

							<h5>
								<p:outputLabel value="Nova Solicitação de Transferência"
									style="font-size:19px" />
							</h5>

							<div align="center">

								<p:outputPanel class="field ui-lg-2 ui-sm-12 ui-g-nopad"
									id="paciente">								

									<div id="paciente" class="ui-lg-12" style="margin-top: 5px">

										<p:outputLabel value="PACIENTE:" style="font-weight:bold;font-size:16px" />										
										<p:outputLabel value="#{transferenciaPacienteBean.transferencia.paciente.nomeCompleto}"
											style="margin-left:2px;font-size:16px" />
											
										<br/>
											
										<p:outputLabel value="PRONTUÁRIO:" style="font-weight:bold;font-size:16px"/>										
										<p:outputLabel value="#{transferenciaPacienteBean.transferencia.paciente.prontuario}"
											style="margin-left:2px;font-size:16px" />
											
										<br/>
											
										<p:outputLabel value="CPF:" style="font-weight:bold;font-size:16px"/>										
										<p:outputLabel value="#{transferenciaPacienteBean.transferencia.paciente.cpf}"
											style="margin-left:2px;font-size:16px" />

									</div>

								</p:outputPanel>

								<div class="field ui-lg-5 ui-sm-12 ui-g-nopad">
									<p:outputLabel for="hospital" value="Hospital de Destino:" />
									<p:selectOneMenu converter="omnifaces.SelectItemsConverter"
										filter="true" filterMatchMode="contains" id="hospital"
										value="#{transferenciaPacienteBean.transferencia.hospitalDestino}"
										autoWidth="false" required="true"
										requiredMessage="Selecione o Hospital de Destino do Paciente!">
										<f:selectItem
											itemLabel="Selecione o Hospital de Destino do Paciente" />
										<f:selectItems var="hospital"
											value="#{transferenciaPacienteBean.hospitaisAtivos}"
											itemValue="#{hospital}" itemDescription="#{hospital.nome}"
											itemLabel="#{hospital.nome}" />
									</p:selectOneMenu>
									<p:tooltip for="hospital">Selecione o Hospital de Destino do Paciente a ser Transferido</p:tooltip>
								</div>

								<div class="field ui-lg-4 ui-sm-12 ui-g-nopad">
									<p:outputLabel for="obs" value="Observações" />
									<p:inputTextarea
										placeholder="Digite a observação (caso necessário)" id="obs"
										value="#{transferenciaPacienteBean.transferencia.observacao}"
										maxlength="500" counter="disp"
										counterTemplate="{0} caracteres restantes." />
									<h:outputText id="disp" class="block" />
								</div>

								<div class=" field ui-lg-2 ui-sm-12 ">

									<p:commandButton icon="fa-solid fa-floppy-disk" value="Salvar"
										style="width:100px" process="@this hospital obs"
										action="#{transferenciaPacienteBean.salvar}" update="@form"
										styleClass="mr-2 mb-2">
										<p:confirm header="Confirmação"
											message="Confirma a solicitação de transferência do paciente informado?" />
									</p:commandButton>

									<p:commandButton icon="pi pi-trash" value="Limpar"
										style="width:100px" 
										action="#{transferenciaPacienteBean.limpar}" process="@this"
										update="@form" styleClass="ui-button-danger mr-2 mb-2" />

								</div>

							</div>

						</p:panel>

						<p:separator />

						<div class="grid table-demo">
							<div class="col-12">
								<div class="card">

									<div class="formgrid grid">

										<div class="field col-12 md:col-3">
											<p:outputLabel value="Nome:" />
											<p:inputText id="nome" type="text" placeholder="NOME"
												maxlength="50" value="#{transferenciaPacienteBean.filtro.nome}"
												style="text-transform: uppercase;" styleClass="mr-2 mb-2" />
											<p:tooltip for="nome">Informe o Nome do Paciente</p:tooltip>
										</div>

										<div class="field col-12 md:col-2">
											<p:outputLabel value="Prontuário:" />
											<p:inputText id="pront" type="text" placeholder="Prontuário"
												maxlength="30"
												value="#{transferenciaPacienteBean.filtro.prontuario}"
												style="text-transform: uppercase;" styleClass="mr-2 mb-2" />
											<p:tooltip for="pront">Informe o Prontuário do Paciente</p:tooltip>
										</div>

										<div class="field col-12 md:col-2">
											<p:outputLabel value="CPF:" />
											<p:inputMask id="cpf"
												value="#{transferenciaPacienteBean.filtro.cpf}"
												mask="999.999.999-99" slotChar="" styleClass="mr-2 mb-2" />
											<p:tooltip for="cpf">Informe o CPF do Paciente</p:tooltip>
										</div>

										<div class="ui-lg-1 ui-sm-12">

											<br />
											<p:commandButton value="Pesquisar" process="@this nome pront cpf" styleClass="ui-g-nopad"
												action="#{transferenciaPacienteBean.listarTransferencias}" update="dtitens"
												icon="pi pi-search" />

										</div>

										<div class="ui-lg-1 ui-sm-12 ">

											<br />
											<p:commandButton value="Limpar"
												styleClass="ui-button-danger ui-g-nopad" process="@this"
												update="dtitens nome pront cpf" action="#{transferenciaPacienteBean.limparFiltros}"
												icon="pi pi-trash" />

										</div>

									</div>


									<p:dataTable id="dtitens" widgetVar="itemDT" lazy="true"
										var="transferencia" style="text-align:center!important"
										paginatorAlwaysVisible="false" paginatorPosition="bottom"
										rows="15" paginator="true"
										value="#{transferenciaPacienteBean.model}" editInitEvent=""
										reflow="true" rowKey="#{transferencia.id}"
										emptyMessage="Nenhum Registro de Trasnferência Encontrado"
										editable="true">

										<f:facet name="header">
											<div align="center" class="ui-lg-12 ui-sm-12">
												<span style="font-weight: bold">SOLICITAÇÕES DE
													TRANSFERÊNCIA REALIZADAS E/OU RECEBIDAS</span>
											</div>
										</f:facet>

										<p:column headerText="Status da Transferência"
											sortBy="#{transferencia.statusTransferencia}"
											style="text-align: center;" styleClass="ui-lg-3 ui-sm-12">
											<span
												class="customer-badge #{transferencia.statusTransferencia.estiloCss}">#{transferencia.statusTransferencia.descricao}</span>
										</p:column>

										<p:column headerText="Paciente" style="text-align: center;"
											styleClass="ui-lg-4 ui-sm-12"
											sortBy="#{transferencia.paciente.nomeCompleto}">
											<h:outputText value="#{transferencia.paciente.nomeCompleto}" />
										</p:column>

										<p:column headerText="Prontuário" style="text-align: center;"
											styleClass="ui-lg-2 ui-sm-12"
											sortBy="#{transferencia.paciente.prontuario}">
											<h:outputText value="#{transferencia.paciente.prontuario}" />
										</p:column>
										
										<p:column headerText="Hospital Atual do Paciente"
											sortBy="#{transferencia.paciente.hospital.nome}"
											style="text-align: center;" styleClass="ui-lg-2 ui-sm-12">											
											<h:outputText value="#{transferencia.paciente.hospital.nome}" />											
										</p:column>										

										<p:column headerText="Hospital de Origem"
											sortBy="#{transferencia.hospitalOrigem.nome}"
											style="text-align: center;" styleClass="ui-lg-3 ui-sm-12">
											<h:outputText value="#{transferencia.hospitalOrigem.nome}" />
										</p:column>

										<p:column headerText="Hospital de Destino"
											sortBy="#{transferencia.hospitalDestino.nome}"
											style="text-align: center;" styleClass="ui-lg-3 ui-sm-12">
											<h:outputText value="#{transferencia.hospitalDestino.nome}" />
										</p:column>

										<p:column headerText="Data-Hora Solicitação"
											style="text-align:center" styleClass="ui-lg-3"
											sortBy="#{transferencia.dataHoraSolicitacao}">
											<h:outputText value="#{transferencia.dataHoraSolicitacao}">
												<f:convertDateTime pattern="dd/MM/yyyy - HH:mm" />
											</h:outputText>
										</p:column>

										<p:column headerText="Usuario Solicitante"
											style="text-align: center;" styleClass="ui-lg-3 ui-sm-12">
											<h:outputText
												value="#{transferencia.usuarioSolicitante.nome}" />
										</p:column>

										<p:column headerText="Data-Hora Aprov/Recusa/Cancelamento"
											style="text-align:center" styleClass="ui-lg-3"
											sortBy="#{transferencia.dataHoraAprovacao}">
											<h:outputText value="#{transferencia.dataHoraAprovacao}">
												<f:convertDateTime pattern="dd/MM/yyyy - HH:mm" />
											</h:outputText>
										</p:column>

										<p:column headerText="Usuário Aprov/Recusa/Cancelamento"
											style="text-align: center;" styleClass="ui-lg-3 ui-sm-12">
											<h:outputText value="#{transferencia.usuarioAprovador.nome}" />
										</p:column>

										<p:column headerText="Opções" styleClass="ui-lg-2 ui-sm-12"
											style="text-align: center;">

											<p:menuButton value="Ações">

												<p:menuitem value="Aprovar Transferência" process="@this"
													icon="pi pi-thumbs-up-fill" style="width: 103%;"
													update="dtitens"
													disabled="#{transferenciaPacienteBean.desabilitaBotaoAcoesTransferencia(transferencia)}"
													action="#{transferenciaPacienteBean.aprovarSolicitacao}">
													<p:confirm header="Confirmação"
														message="Deseja realmente aprovar a solicitação de transferência? Após aprovada a transferência o paciente passará a fazer parte do cadastro desse hospital!"
														icon="pi pi-exclamation-triangle" />
													<f:setPropertyActionListener value="#{transferencia}"
														target="#{transferenciaPacienteBean.transferenciaSelecionada}" />
												</p:menuitem>

												<p:menuitem value="Negar Transferência" process="@this"
													update="dlgrecusa"
													disabled="#{transferenciaPacienteBean.desabilitaBotaoAcoesTransferencia(transferencia)}"
													icon="pi pi-thumbs-down-fill" style="width: 103%;"
													action="#{transferenciaPacienteBean.reprovarSolicitacao}">
													<f:setPropertyActionListener value="#{transferencia}"
														target="#{transferenciaPacienteBean.transferenciaSelecionada}" />
												</p:menuitem>

												<p:menuitem value="Cancelar Solicitação" icon="pi pi-trash"
													process="@this"
													action="#{transferenciaPacienteBean.excluirSolicitacao}"
													update="@form"
													disabled="#{transferenciaPacienteBean.desabilitaBotaoAcaoExclusao(transferencia)}">
													<p:confirm header="Confirmação"
														message="Deseja realmente cancelar a solicitação de transferência?"
														icon="pi pi-exclamation-triangle" />
													<f:setPropertyActionListener value="#{transferencia}"
														target="#{transferenciaPacienteBean.transferenciaSelecionada}" />
												</p:menuitem>

												<p:menuitem value="Visualizar Detalhes" icon="pi pi-eye"
													update="dlgdetalhes" process="@this"
													action="#{transferenciaPacienteBean.visualizarDetalhes}">
													<f:setPropertyActionListener value="#{transferencia}"
														target="#{transferenciaPacienteBean.transferenciaSelecionada}" />
												</p:menuitem>
												
												<p:menuitem value="Histórico" icon="pi pi-clock"
													update="historico" process="@this"
													action="#{transferenciaPacienteBean.visualizarHistoricoMovimentacoes(transferencia.paciente)}">													
												</p:menuitem>

											</p:menuButton>

										</p:column>

									</p:dataTable>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
			
			<p:dialog header="Justificativa para Recusa" id="dlgrecusa" showEffect="fade" modal="true"
                      widgetVar="dlgRecusa" responsive="true">
                <p:outputPanel id="pnlrecusa" class="ui-fluid">
                    <div class="field">
                        <p:outputLabel for="justlib">Justificativa para Recusa de Transferência</p:outputLabel>
                        <p:inputTextarea maxlength="500" counter="disp2" counterTemplate="{0} caracteres restantes." placeholder="Informe a justificativa para recusa de transferência."
                                         id="justlib" value="#{transferenciaPacienteBean.justificativaRecusaInformada}"
                                         required="true" requiredMessage="A justificativa para recusa de transferência é obrigatória!"/>
                        <br/>
                        <h:outputText id="disp2"/>
                    </div>

                </p:outputPanel>

                <f:facet name="footer">
                    <div align="center">
                        <p:commandButton value="Salvar" icon="pi pi-check" update="dtitens"
                                         action="#{transferenciaPacienteBean.finalizarRecusaTransferencia}"
                                         styleClass="ui-button-success" 
                                         process="justlib @this">
                            <p:confirm header="Confirmação"
                                       message="Deseja realmente recusar a transferência do paciente informado?"/>
                        </p:commandButton>
                        <p:commandButton value="Cancelar" action="#{transferenciaPacienteBean.cancelarRecusaTransferenciaDePaciente}" update="@form" icon="pi pi-times" onclick="PF('dlgRecusa').hide()"
                                         styleClass="ui-button-danger" process="@this"/>
                    </div>
                </f:facet>
            </p:dialog>
            
            <p:dialog header="Ajuste de Prontuário" id="dlgajuste" showEffect="fade" modal="true"
                      widgetVar="dlgAjuste" responsive="true">
                <p:outputPanel id="pnlajuste" class="ui-fluid">
                    <div class="field">                        
                        <p:outputLabel value="Novo Número de Prontuário:" for="@next" />
						<p:inputText value="#{transferenciaPacienteBean.transferenciaSelecionada.paciente.prontuario}"
						onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
						id="prontuario" required="true" maxlength="10" style="text-transform:uppercase;"
						requiredMessage="Número do Prontuário é obrigatório" />                    
                    </div>

                </p:outputPanel>

                <f:facet name="footer">
                    <div align="center">
                        <p:commandButton value="Salvar" icon="pi pi-check" update="dtitens"
                                         action="#{transferenciaPacienteBean.aprovarSolicitacao}"
                                         styleClass="ui-button-success" 
                                         process="prontuario @this">                            
                        </p:commandButton>
                        <p:commandButton value="Cancelar" action="#{transferenciaPacienteBean.cancelarRecusaTransferenciaDePaciente}" update="@form" icon="pi pi-times" onclick="PF('dlgRecusa').hide()"
                                         styleClass="ui-button-danger" process="@this"/>
                    </div>
                </f:facet>
            </p:dialog>
            
            <p:dialog header="Detalhes da Solicitação de Transferência" id="dlgdetalhes" showEffect="fade" modal="true" widgetVar="dlgDetalhes" responsive="true">

				<p:outputPanel class="field ui-fluid" >
					<p:outputLabel value="Status da Transferência:" style="font-weight:bold"/>
					<br/>					
					<p:outputLabel value="#{transferenciaPacienteBean.transferenciaSelecionada.statusTransferencia.descricao}"/>					
				</p:outputPanel>

				<p:outputPanel class="field ui-fluid" >
					<p:outputLabel value="Observações:" style="font-weight:bold"/>
					<br/>
					<p:outputLabel value="#{transferenciaPacienteBean.transferenciaSelecionada.observacao}" rendered="#{transferenciaPacienteBean.transferenciaSelecionada.observacao!=null}"/>
					<p:outputLabel value="Nenhuma observação de transferência cadastrada" rendered="#{transferenciaPacienteBean.transferenciaSelecionada.observacao==null}"/>
				</p:outputPanel>

				<p:outputPanel class="field ui-fluid" rendered="#{transferenciaPacienteBean.transferenciaSelecionada.motivoRecusaTransferencia!=null}">
					<p:outputLabel value="Justificativa para Recusa de Transferência:" style="font-weight:bold"/>
					<br/>
					<p:outputLabel value="#{transferenciaPacienteBean.transferenciaSelecionada.motivoRecusaTransferencia}" />
				</p:outputPanel>

			</p:dialog>
			
			<p:dialog header="Histórico de Hospitais do Paciente" id="dlghistorico" showEffect="fade" modal="true" widgetVar="dlgHistoricoMovimentacoes" responsive="true" width="50%">

				<div class="grid table-demo">
				<div class="col-12">
					<div class="card">

						<p:dataTable id="historico" widgetVar="historicoDT" var="historico" style="text-align:center!important"							
							value="#{transferenciaPacienteBean.historicoMovimentos}"
							reflow="true" rows="5" paginator="true" sortBy="#{historico.dataHoraEntrada}"
							paginatorAlwaysVisible="false" scrollable="true"
							scrollHeight="500" paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
							currentPageReportTemplate="Exibindo de {startRecord} a {endRecord} no total de {totalRecords} registros - Página: {currentPage}/{totalPages}"
							styleClass="ui-datatable-striped ui-datatable-sm">

							<p:column headerText="Paciente" width="200"
								style="text-align:center">
								<h:outputText style="vertical-align: middle; margin-left: .5rem"
									value="#{historico.paciente.nomeCompleto}" />
							</p:column>
							
							<p:column headerText="Hospital"
								style="text-align:center" width="200">
								<h:outputText value="#{historico.hospital.nome}" />
							</p:column>

							<p:column headerText="Data-hora de entrada" width="140"
								sortBy="#{historico.dataHoraEntrada}"
								style="text-align:center">
								<h:outputText value="#{historico.dataHoraEntrada}">
									<f:convertDateTime pattern="dd/MM/yyyy - HH:mm" />
								</h:outputText>
							</p:column>
							
							<p:column headerText="Data-hora de saída" width="140"
								sortBy="#{historico.dataHoraSaida}"
								style="text-align:center">
								<h:outputText value="#{historico.dataHoraSaida}">
									<f:convertDateTime pattern="dd/MM/yyyy - HH:mm" />
								</h:outputText>
							</p:column>							

						</p:dataTable>

					</div>
				</div>
			</div>

			</p:dialog>

		</h:form>
	</ui:define>

</ui:composition>