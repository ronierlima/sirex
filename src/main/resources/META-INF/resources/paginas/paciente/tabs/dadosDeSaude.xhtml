<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

	<p:accordionPanel value="#{incluirPacienteBean.paciente.estomias}"
		widgetVar="wdAccordion" varStatus="status" var="estomia"
		multiple="false" activeIndex="0" id="accordion">

		<p:tab>

			<p:staticMessage rendered="#{incluirPacienteBean.paciente.id !=null}"
				severity="WARN" detail="#{incluirPacienteBean.mensagemReavaliacao}"
				style="margin-bottom:10px" summary="Atenção:" />

			<f:facet name="title">

				<i class="fa-solid fa-user-doctor"></i>
				<p:outputLabel value=" Estomia - Diagnóstico" />
				<span class="customer-badge status-#{estomia.statusCss}">#{estomia.ativo
					? 'Ativo' : 'Inativo'}</span>
				<p:commandButton value="Adicionar Estomia" icon="pi pi-plus"
					rendered="#{status.index == 0}" disabled="#{seguranca.naoPodeEditarDadosSaudeDoPaciente}"
					oncomplete="PF('wdAccordion').unselectAll();PF('wdAccordion').select(#{incluirPacienteBean.indexTab});"
					action="#{incluirPacienteBean.addEstomia}"
					update="frmPrincipal:accordion" process="frmPrincipal:accordion"
					style="position: absolute;right: 5px;margin-top:-10px !important" />
					
				<p:commandButton value="Remover Estomia" icon="pi pi-trash" styleClass="ui-button-danger"
					rendered="#{status.index != 0 and estomia.novo}" disabled="#{seguranca.naoPodeEditarDadosSaudeDoPaciente}"
					oncomplete="PF('wdAccordion').unselectAll();PF('wdAccordion').select(0);"
					action="#{incluirPacienteBean.removerEstomia(estomia)}"
					update="frmPrincipal:accordion" process="@this"
					style="position: absolute;right: 5px;margin-top:-10px !important" />

			</f:facet>

			<p:outputPanel styleClass="ui-fluid formgrid grid" id="grid">

				<div class="field col-12 md:col-4">
					<p:outputLabel value="Hospital de Origem" for="@next"/>					
					<p:autoComplete id="hospitalOrigem" inputStyle="text-transform:uppercase!important" value="#{estomia.nomeHospitalOrigem}"
					onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }" 
					emptyMessage="Nenhum Registro Encontrado" placeholder="Nome do Hospital"
					disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
                                completeMethod="#{incluirPacienteBean.completarHospital}" scrollHeight="250"/>						
				</div>

				<div class="field col-12 md:col-3">
					<p:outputLabel value="Nome do Cirugião" for="@next" />
					<p:inputText value="#{estomia.nomeCirurgiao}" style="text-transform:uppercase"
						onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						placeholder="Responsavél pela realização da Estomia." />
				</div>

				<div class="field col-12 md:col-2">
					<p:outputLabel value="Data da Cirurgia" for="@next" />
					<p:calendar value="#{estomia.dataCirurgia}" mask="99/99/9999"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						yearRange="c-100:c+100" navigator="true" pattern="dd/MM/yyyy"
						maxdate="today()" />
				</div>

				<div class="field col-12 md:col-3">
					<p:outputLabel value="Diagnóstico" for="@next" />
					<p:inputText value="#{estomia.diagnostico}" style="text-transform:uppercase"
						onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						placeholder="Diagnóstico que levou à realização do estoma." />
				</div>

				<div class="field col-12 md:col-2">
					<p:outputLabel value="Cirurgia Realizada" for="@next" />
					<p:inputText value="#{estomia.cirurgiaRealizada}" style="text-transform:uppercase"
						onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}" />
				</div>

				<div class="field col-3">
					<p:outputLabel value="Tipo de Estoma" for="@next" />

					<p:selectOneMenu value="#{estomia.tipoEstomia}" autoWidth="false"
						converter="omnifaces.SelectItemsConverter"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}">

						<f:selectItem itemLabel="Selecione" itemValue="#{null}"
							noSelectionOption="true" />

						<f:selectItems value="#{incluirPacienteBean.tiposDeEstomias}"
							var="tipoEstomia" itemLabel="#{tipoEstomia.descricao}"
							itemValue="#{tipoEstomia}" />

					</p:selectOneMenu>

				</div>

				<div class="field col-3">
					<p:outputLabel value="Classificação de Reversibilidade" for="@next" />
					<p:selectOneMenu value="#{estomia.tipoReversibilidade}"
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}" id="classrev"
						autoWidth="false" converter="omnifaces.SelectItemsConverter">
						<p:ajax
							listener="#{incluirPacienteBean.onClassificacaoChange(estomia)}"
							global="false"
							update=":frmPrincipal:accordion:statusrev,:frmPrincipal:accordion:dtreversao" />
						<f:selectItem itemLabel="Selecione" itemValue="#{null}"
							noSelectionOption="true" />
						<f:selectItems
							value="#{incluirPacienteBean.tiposDeReversibilidades}" var="tipo"
							itemLabel="#{tipo.descricao}" itemValue="#{tipo}" />
					</p:selectOneMenu>

				</div>

				<div class="field col-2">
					<p:outputLabel value="Status da Reversibilidade" for="@next" />
					<div class="ui-inputgroup">
						<p:selectOneMenu styleClass="ui-sm-12"
							required="#{estomia.tipoReversibilidade.temporaria}"
							requiredMessage="O status da reversibilidade é obrigatório!"
							disabled="#{!estomia.tipoReversibilidade.temporaria or estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
							id="statusrev" value="#{estomia.statusReversibilidade}">
							<p:ajax process="@this" global="false"
								update=":frmPrincipal:accordion:dtreversao" />
							<f:selectItem itemLabel="Selecione" itemValue="#{null}"
								noSelectionOption="true" />
							<f:selectItems
								value="#{incluirPacienteBean.statusReversibilidade}" var="s"
								itemLabel="#{s.descricao}" itemValue="#{s}" />
						</p:selectOneMenu>

						<p:commandButton process="@this"
							pt:data-tooltip="Clique para Visualizar o Histórico de Reversibilidade."							
							actionListener="#{incluirPacienteBean.abrirDlgHistoricoReversibilidade}"
							icon="fa fa-history">
							<f:setPropertyActionListener value="#{estomia}"
								target="#{incluirPacienteBean.estomiaSelecionada}" />
						</p:commandButton>

					</div>
				</div>

				<div class="field col-12 md:col-2">
					<p:outputLabel value="Data da Reversão" for="@next" />
					<p:calendar required="#{estomia.estomiaRevertida}"
						requiredMessage="A data da reversão é obrigatória!"
						value="#{estomia.dataReversao}" id="dtreversao" mask="99/99/9999"
						disabled="#{!estomia.estomiaRevertida or estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						yearRange="c-100:c+100" navigator="true" pattern="dd/MM/yyyy"
						maxdate="today()">
					</p:calendar>
				</div>
				
				<p:outputPanel styleClass="field col-3" rendered="#{incluirPacienteBean.atendimentoReavaliacaoEmCurso}">
					<p:outputLabel value="Definir Próxima Reavaliação Manualmente?" for="@next" />
					<p:selectOneMenu value="#{incluirPacienteBean.alterarDataReavaliacao}" autoWidth="false"						
						disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}">
						<p:ajax listener="#{incluirPacienteBean.onSelectAlteraDataProximaReavaliacao}" update="frmPrincipal:accordion:#{status.index}:dtrevinf"/>
						<f:selectItem itemLabel="Não" itemValue="#{false}"/>
						<f:selectItem itemLabel="Sim" itemValue="#{true}"/>
					</p:selectOneMenu>
				</p:outputPanel>
				
				<p:outputPanel class="field col-12 md:col-3" rendered="#{!incluirPacienteBean.paciente.novo}">
					<p:outputLabel value="Data da Próxima Reavaliação" for="@next"/>					
						<p:calendar required="true" requiredMessage="A Data da Próxima Reavaliação é Obrigatória!" id="dtrevinf"
						value="#{incluirPacienteBean.dataProximaReavaliacaoInformada}" mask="99/99/9999"
						disabled="#{estomia.desabilitaCamposEdicao or (!incluirPacienteBean.alterarDataReavaliacao and incluirPacienteBean.atendimentoReavaliacaoEmCurso) or seguranca.naoPodeEditarDadosSaudeDoPaciente}" mindate="today()" yearRange="c-1:c+1" navigator="true" pattern="dd/MM/yyyy">
							<p:ajax event="blur" global="false" listener="#{incluirPacienteBean.validaDataProximaReavaliacao}" update="frmPrincipal:accordion:#{status.index}:dtrevinf"/>
						</p:calendar>						
											
				</p:outputPanel>
				
				<p:outputPanel class="field col-12 md:col-2" rendered="#{!incluirPacienteBean.paciente.novo}">
					<p:outputLabel value="Data da Próxima Retirada" for="@next"/>					
						<p:calendar required="true" requiredMessage="A Data da Próxima Retirada é Obrigatória!" id="dtnextret"
						value="#{incluirPacienteBean.dataProximaRetiradaInformada}" mask="99/99/9999"
						disabled="#{estomia.desabilitaCamposEdicao or incluirPacienteBean.atendimentoReavaliacaoEmCurso or seguranca.naoPodeEditarDadosSaudeDoPaciente}" mindate="today()" yearRange="c-1:c+1" navigator="true" pattern="dd/MM/yyyy">
						<p:ajax event="blur" global="false" listener="#{incluirPacienteBean.validaDataProximaRetirada}" update="frmPrincipal:accordion:#{status.index}:dtnextret"/>
					</p:calendar>						
											
				</p:outputPanel>
				
				<br/>

				<p:outputPanel styleClass="field col-12 md:col-12"
					rendered="#{estomia.exibeCampoJustificativaInaptidao}">
					<p:outputLabel value="Justificativa para Inaptidão:" for="@next" />
					<p:inputTextarea disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						counterTemplate="{0} caracteres restantes." maxlength="250"
						counter="dsp" value="#{estomia.justificativaInaptidao}"
						required="true"
						requiredMessage="A justificativa para o status de reversibilidade INAPTO, é obrigatória!"
						placeholder="Informe a justificativa pelo status da reversibilidade INAPTO." />
					<br />
					<h:outputText id="dsp" />
				</p:outputPanel>

				<p:outputPanel styleClass="field-checkbox field col-12 md:col-12" rendered="#{estomia.renderizaCamposInativacao}">
					<p:selectBooleanCheckbox value="#{estomia.desabilitarEstomia}"
						id="inativar" disabled="#{estomia.dataInativacao!=null or seguranca.naoPodeEditarDadosSaudeDoPaciente}">
						<p:ajax event="change" process="@this"
							update=":frmPrincipal:accordion:#{status.index}:grid" />
					</p:selectBooleanCheckbox>
					<p:tooltip rendered="#{!estomia.desabilitarEstomia}" for="inativar">Clique para inativar o Registro</p:tooltip>
					<p:outputLabel for="inativar">#{estomia.ativo?'Inativar Estomia':'Estomia Inativa'}</p:outputLabel>
				</p:outputPanel>

				<p:outputPanel styleClass="field col-12"
					rendered="#{estomia.renderizaJustificativaParaInativacao}" id="motivodis">
					<p:outputLabel value="Motivo da Inativação" for="@next" />
					<p:inputTextarea disabled="#{estomia.dataInativacao!=null}"
						counterTemplate="{0} caracteres restantes." maxlength="250"
						counter="display" value="#{estomia.motivoInativacao}"
						required="#{!estomia.ativo}"
						requiredMessage="O motivo da inativação é obrigatório!"
						placeholder="Informe o motivo da inativação da estomia." />
					<br />
					<h:outputText id="display" />
				</p:outputPanel>

				<div class="field col-12">
					<p:outputLabel value="Observação" for="@next" />
					<p:inputTextarea disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
						counterTemplate="{0} caracteres restantes." maxlength="250"
						counter="display2" value="#{estomia.observacao}"
						placeholder="Se necessário adicione aqui uma observação." />
					<br />
					<h:outputText id="display2" />
				</div>

				<div class="col-12">

					<p:fieldset legend="Itens" id="fielSet">
						<div class="ui-fluid formgrid grid">

							<div class="field col-12 md:col-2">

								<p:outputLabel value="Marca" for="@next" />

								<p:selectOneMenu value="#{estomia.itemBolsa.produto.marca}"
									disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}" autoWidth="false"
									converter="omnifaces.SelectItemsConverter" filter="true"
									filterMatchMode="contains">

									<p:ajax process="@this" update="tipoBolsa"
										listener="#{incluirPacienteBean.listarBolsas(estomia.itemBolsa)}" />

									<f:selectItem itemLabel="Selecione" itemValue="#{null}"
										noSelectionOption="true" />

									<f:selectItems value="#{incluirPacienteBean.marcasBolsas}"
										var="marcas" itemLabel="#{marcas.descricao}"
										itemValue="#{marcas}" />

								</p:selectOneMenu>
							</div>

							<div class="field col-12 md:col-4">

								<p:outputLabel value="Tipo de Bolsa" for="@next" />

								<p:selectOneMenu value="#{estomia.itemBolsa.produto}"
									id="tipoBolsa" autoWidth="false"
									disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
									converter="omnifaces.SelectItemsConverter" filter="true"
									filterMatchMode="contains">

									<f:selectItem itemLabel="Selecione" itemValue="#{null}"
										noSelectionOption="true" />

									<f:selectItems value="#{estomia.itemBolsa.bolsas}"
										itemDescription="#{bolsa.descricao}" var="bolsa"
										itemLabel="#{bolsa.descricaoReduzida}" itemValue="#{bolsa}" />

								</p:selectOneMenu>
							</div>

							<div class="field col-12 md:col-2">

								<p:outputLabel value="Quantidade" for="@next" />
								<p:inputNumber value="#{estomia.itemBolsa.quantidade}"
									onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
									disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}" modifyValueOnWheel="false" maxlength="5"
									maxValue="99999" thousandSeparator="" decimalPlaces="0" />

							</div>

							<div class="col-12 md:col-4">
								<div class="formgroup-inline">

									<div class="field col-6">
										<p:commandButton value="Estoque da Farmácia" process="@this"
											disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
											style="margin-left:2px" styleClass="ui-button-success"
											actionListener="#{incluirPacienteBean.abrirDlgEstoque}"
											pt:data-tooltip="Clique p/ Visualizar o Estoque da Farmácia."
											icon="fa fa-fw fa-house-medical" />
									</div>
									<div class="field col-6">
										<p:commandButton process=":frmPrincipal:accordion:fielSet"
											update=":frmPrincipal:accordion:fielSet"
											disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
											action="#{incluirPacienteBean.addAdjuvante(estomia)}"
											value="Adicionar Adjuvante" icon="pi pi-plus" />
									</div>
									
									<div class="field col-6">
										<p:commandButton process="@this" rendered="#{seguranca.podeCadastrarBolsaTeste}"
											update=":frmPrincipal:accordion:fielSet" style="background-color: #FFA500;"
											disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
											action="#{incluirPacienteBean.addBolsaTeste(estomia)}"
											value="Adicionar Bolsa de Teste" icon="pi pi-plus" />
									</div>
									
								</div>
							</div>


							<p:outputPanel styleClass="ui-fluid formgrid grid col-12"
								id="pnlAddAdjuvante" rendered="#{not empty estomia.adjuvantes}">

								<ui:repeat var="adjuvante" value="#{estomia.adjuvantes}">
									<div class="field col-12 md:col-4">

										<p:outputLabel value="Adjuvante" for="@next" />

										<p:selectOneMenu value="#{adjuvante.produto}"
											autoWidth="false" converter="omnifaces.SelectItemsConverter"
											filter="true" filterMatchMode="contains" disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}">

											<f:selectItem itemLabel="Selecione" itemValue="#{null}"
												noSelectionOption="true" />

											<f:selectItems value="#{incluirPacienteBean.adjuvantes}"
												var="bolsa" itemLabel="#{bolsa.descricaoReduzida}"
												itemValue="#{bolsa}" itemDescription="#{bolsa.descricao}" />

										</p:selectOneMenu>
									</div>

									<div class="field col-12 md:col-2">
										<p:outputLabel value="Quantidade" for="@next" />
										<p:inputText value="#{adjuvante.quantidade}" onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }" disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"/>
									</div>

									<div class="field col-12 md:col-3">

										<p:outputLabel value="Recorrência" for="@next" />

										<div class="ui-inputgroup">
											<p:selectOneMenu value="#{adjuvante.recorrencia}" disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
												autoWidth="false" converter="omnifaces.SelectItemsConverter">

												<f:selectItem itemLabel="Selecione" itemValue="#{null}"
													noSelectionOption="true" />

												<f:selectItems value="#{incluirPacienteBean.recorrencias}"
													var="recorrencia" itemLabel="#{recorrencia.descricao}"
													itemValue="#{recorrencia}" />

											</p:selectOneMenu>

											<p:commandButton
												action="#{incluirPacienteBean.removerAdjuvante(estomia, adjuvante)}"
												update=":frmPrincipal:accordion:fielSet" disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
												process=":frmPrincipal:accordion:fielSet @this"
												styleClass="ui-button-danger" value="Excluir"
												icon="pi pi-trash" />


										</div>
									</div>

								</ui:repeat>
							</p:outputPanel>
							
							<p:outputPanel styleClass="ui-fluid formgrid grid col-12"
								id="pnlAddBolsaTeste" rendered="#{not empty estomia.bolsasTeste}">
								
								<p:separator style="width:100%;height:10px"/>
								<p:outputLabel value="BOLSAS DE TESTE" style="font-weight:bold!important;margin-left:50%"/>								
								<p:separator style="width:100%;height:10px"/>

								<ui:repeat var="bolsaTeste" value="#{estomia.bolsasTeste}">

									<div class="field col-12 md:col-3">

										<p:outputLabel value="Marca da Bolsa de Teste:" for="@next" />
										<p:selectOneMenu value="#{bolsaTeste.produto.marca}"
											disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
											autoWidth="false" converter="omnifaces.SelectItemsConverter"
											filter="true" filterMatchMode="contains">

											<p:ajax process="@this" update="tipoBolsaTeste"
												listener="#{incluirPacienteBean.listarBolsasTeste(bolsaTeste)}" />

											<f:selectItem itemLabel="Selecione" itemValue="#{null}"
												noSelectionOption="true" />

											<f:selectItems value="#{incluirPacienteBean.marcasBolsas}"
												var="marcas" itemLabel="#{marcas.descricao}"
												itemValue="#{marcas}" />
										</p:selectOneMenu>

									</div>


									<div class="field col-12 md:col-5">
										<p:outputLabel value="Tipo de Bolsa de Teste:" for="@next" />										
										<p:selectOneMenu value="#{bolsaTeste.produto}"
											id="tipoBolsaTeste" autoWidth="false"
											disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
											converter="omnifaces.SelectItemsConverter" filter="true"
											filterMatchMode="contains">

											<f:selectItem itemLabel="Selecione" itemValue="#{null}"
												noSelectionOption="true" />
											<f:selectItems value="#{bolsaTeste.bolsasTeste}"
												itemDescription="#{bolsa.descricao}" var="bolsa"
												itemLabel="#{bolsa.descricaoReduzida}" itemValue="#{bolsa}" />

										</p:selectOneMenu>
									</div>

									<div class="field col-12 md:col-2">
										<p:outputLabel value="Quantidade:" for="@next" />
										<div class="ui-inputgroup">
											<p:inputText value="#{bolsaTeste.quantidade}" id="qtdBolsaTeste"
												onkeypress="if(event.keyCode == 13){ event.preventDefault(); return false; }"
												disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}" />
											<p:tooltip for="qtdBolsaTeste">A quantidade de bolsas de teste entregues não descontará do total de bolsas principais do paciente.</p:tooltip>
											<p:commandButton action="#{incluirPacienteBean.removerBolsaTeste(estomia, bolsaTeste)}"
												update=":frmPrincipal:accordion:fielSet"
												disabled="#{estomia.desabilitaCamposEdicao or seguranca.naoPodeEditarDadosSaudeDoPaciente}"
												process=":frmPrincipal:accordion:fielSet @this"
												styleClass="ui-button-danger" value="Excluir"
												icon="pi pi-trash" />
										</div>
									</div>									

								</ui:repeat>
							</p:outputPanel>
							
							
						</div>
					</p:fieldset>

				</div>

			</p:outputPanel>

		</p:tab>
	</p:accordionPanel>


</ui:composition>